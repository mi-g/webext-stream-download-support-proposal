
This proposal extends the WebExtensions downloads API to support creating files from an add-on.

# Rationale

A File writing API could be sufficient for most needs, but since the operation generally appears to the end-user as a download of some kind, it makes sense to 
integrate the feature into the `downloads` API.

# Use cases

Video DownloadHelper needs an API of this kind for:
- downloading chunked streaming (HLS, DASH, F4F protocols) where the final file is constructed by downloading and processing internally several HTTP video fragments
- using the *masked download* feature: downloading and encrypting a document on the fly so the file never lands to the disk in clear
- *screen capture* feature: some videos are generated by capturing frames from the browser page

An extension like DownThemAll would use the API to perform parallel download requests of several parts of the original document.

# Extending the downloads API

## downloads.download()

```
var downloading = browser.downloads.download(
  options                   // object
)
```

### options

**url**: now optional. If not set, the download is of stream type.

**filename**: unchanged.

**conflictAction**: unchanged.

**saveAs**: unchanged.

**method**: unused for streams.

**header**: unused for streams.

**body**: unused for streams.

**canPause**: new. Whether this stream supports pausing and should display the Pause entry in the download manager menu. Default is *true*.

### *Return value*

Unchanged. The returned *Promise* gets its success callback invoked with the id of a modified `downloads.DownloadItem`.

## downloads.DownloadItem

If the DownloadItem has been created as a stream from the `downloads.download()` method, it has the following properties:

**id**: unchanged.

**url**: not set.

**referrer**: not set.

**filename**: unchanged.

**incognito**: unchanged.

**danger**: unchanged.

**mime**: not set (?).

**startTime**: unchanged.

**endTime**: unchanged.

**estimatedEndTime**: unchanged.

**state**: unchanged.

**paused**: unchanged.

**canResume**: unchanged.

**error**: unchanged.

**bytesReceived**: property is now read/write since only the add-on knows the actual number of received bytes.

**totalBytes**: property is now read/write since only the add-on knows, or doesn't, the final number of bytes.

**fileSize**: unchanged.

**exists**: unchanged.

**byExtensionIdOptional**: unchanged.

**byExtensionName**: unchanged.

**write()**: the method for the add-on to write bytes to the target file.

Modeled after the [OS.File.write](https://developer.mozilla.org/en-US/docs/Mozilla/JavaScript_code_modules/OSFile.jsm/OS.File_for_the_main_thread#write%28%29) specifications.

```
Promise<number> write(
  in ArrayBufferView source
  [optional] in object options
)
```

**setPosition()**: move the file pointer to a specified index.

Modeled after the [OS.File.setPosition](https://developer.mozilla.org/en-US/docs/Mozilla/JavaScript_code_modules/OSFile.jsm/OS.File_for_the_main_thread#setPosition%28%29) specifications.

```
Promise<void> setPosition(
  in number offset,
  in object origin
)
```

In the original *OS.File* specifications, `origin` takes values `POS_START`, `POS_CUR` or `POS_END` from within the `OS.File` namespace, so `downloads.POS_START`, `downloads.POS_CUR` and `downloads.POS_END` should be defined.

**close()**: ends the stream download successfully.

Modeled after the [OS.File.close](https://developer.mozilla.org/en-US/docs/Mozilla/JavaScript_code_modules/OSFile.jsm/OS.File_for_the_main_thread#close%28%29) specifications.

```
Promise<void> close()
```

**abort()**: terminates the stream download with an error.

```
Promise<void> abort(
  in string reason
)
```

We could also avoid the need for the `abort()` function by passing an argument to the `close()` function.

Should `reason` be any string, or maybe value `ADDON_TERMINATED` with an additional argument to tell the user the cause of the error that only the add-on knows ?

**read()**: reads the file being written.

While not needed by Video DownloadHelper, this function could be useful to some other add-ons (?)

Modeled after the [OS.File.read](https://developer.mozilla.org/en-US/docs/Mozilla/JavaScript_code_modules/OSFile.jsm/OS.File_for_the_main_thread#read%28%29) specifications.

```
Promise<Uint8Array> read(
  [optional] in number bytes
)
```

## downloads.search()

```
var searching = browser.downloads.search(query);
```

### query

Additional optional property `stream` to indicate if regular downloads (false) or stream downloads (true) are queried.

## other downloads.xxx() functions are unchanged
